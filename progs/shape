function cc_include( f )
	if require then
        package.path = '../?.lua;'..package.path
		require( f )
	else
		dofile( '/john/'..f..'.lua' )
	end
end

cc_include( 'util' )
cc_include( 'dstarlite' )
cc_include( 'coord_move' )
cc_include( 'shapes' )
-- cc_include( 'NodeMap' )
cc_include( 'PQueue' )

t = trackable( turtle )

function refilldirt( t )
    local refilled = false
    local i = 2

    while t( 'getItemCount', 1 ) < 64 and i < 17 do
        t( 'select', i )
        if t( 'compareTo', 1 ) then
            t( 'transferTo', 1 )
        end

        i = i + 1
    end

    return t( 'getItemCount', 1 ) > 1
end

function persistentMove( t )
    for i=1, 15 do
        if t( 'forward' ) then return true end
        if not t( 'dig' ) then
            os.sleep( 2 )
        end
    end
    return false
end

local things = {
    slab = function(t, width, depth )
        shape.rect( t, {
            v2 = { tonumber( width or 3 ), tonumber( depth or 3 ), 0, 0 },
            xbefore = function()
                t( 'digUp' )
                t( 'dig' )
                t( 'digDown' )
            end,
            filled = true,
            move = persistentMove,
            after = function()
                if t( 'getItemCount', 1 ) == 1 then
                    if not refilldirt( t ) then
                        print( 'Ran out of dirt' )
                        return false
                    end
                end
                t( 'select', 1 )
                if not t( 'placeDown' ) then
                    t( 'digUp' )
                    if t( 'digDown' ) then
                        if not t( 'placeDown' ) then
                            return false
                        end
                    else
                        -- what?  don't know
                        return false
                    end
                end
            end
        })
    end,

    rect = function( t, width, depth, height )
        width = tonumber( width or nil )
        depth = tonumber( depth or nil )
        height = tonumber( height or nil )

        if not height then height = 1 end
        if not width or not depth then
            print( 'rect requires a width and depth.  optionally a height also.' )
            return false
        end

        for i=1,height do
            --local state = t( 'getState' )
            shape.rect( t, {
                v2 = { tonumber( width ), tonumber( depth ), 0, 0 },
                xbefore = function()
                    t( 'digUp' )
                    t( 'dig' )
                    t( 'digDown' )
                end,
                move = persistentMove,
                after = function()
                    if t( 'getItemCount', 1 ) == 1 then
                        if not refilldirt( t ) then
                            print( 'Ran out of dirt' )
                            return false
                        end
                    end
                    t( 'select', 1 )
                    if not t( 'placeDown' ) then
                        t( 'digUp' )
                        if t( 'digDown' ) then
                            if not t( 'placeDown' ) then
                                return false
                            end
                        else
                            -- what?  don't know
                            return false
                        end
                    end
                end
            })

            t( 'forward' )
            t( 'up' )
            t( 'turnRight' )
            t( 'back' )
            --state.z = state.z + 1
            --gostate( t, state )
        end
    end,

    wall = function( t, width, height )
    end
}

local args = {...}

if table.getn( args ) < 1 then
    print( 'Usage: shape [ args ]' )
    return
end

if things[ args[1] ] then
    local fn = args[1]
    args[1] = t
    things[ fn ]( unpack( args ) )
else
    print( 'Unknown shape.' )
end

